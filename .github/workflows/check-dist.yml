# `dist/index.js` is a special file in Actions.
# When you reference an action with `uses:` in a workflow,
# `index.js` is the code that will run.
# For our project, we generate this file through a build process from other source files.
# We need to make sure the checked-in `index.js` actually matches what we expect it to be.
name: Check dist/

on:
  push:
    branches:
    - main
    paths-ignore:
    - '**.md'
  pull_request_target:
    paths-ignore:
    - '**.md'
  workflow_dispatch:

permissions: {}

jobs:
  check-dist:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Set up Node
      uses: actions/setup-node@v4.0.0
      with:
        node-version-file: '.nvmrc'

    - name: Install dependencies
      run: npm ci

    - name: Rebuild the dist/ directory
      run: |
        npm run build
        npm run package

    - name: Compare the expected and actual dist/ directories
      if: github.event.pull_request.user.login != 'dependabot[bot]'
      run: |
        if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
          echo "Detected uncommitted changes after build. See status below:"
          git diff
          exit 1
        fi
      id: diff

    - uses: actions/upload-artifact@v3
      if: >
        failure() &&
        steps.diff.conclusion == 'failure' &&
        github.event.pull_request.user.login != 'dependabot[bot]'
      with:
        name: dist
        path: dist/

    - name: Commit changes to build files
      if: github.event.pull_request.user.login == 'dependabot[bot]'
      run: |
        if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
          echo "Detected uncommitted changes after build. See status below:"
          git diff

          git config --global user.email "swissspidy@users.noreply.github.com"
          git config --global user.name "Pascal Birchler"
          git add dist/*
          git commit -m "Update build files [dependabot skip]"
          git push -u origin HEAD
        fi
